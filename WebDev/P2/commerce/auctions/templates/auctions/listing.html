{% extends "auctions/layout.html" %}
{% load static %}

{% block head %}
    <link href="{% static 'auctions/listing.css' %}" rel="stylesheet">
{% endblock %}

{% block body %}
    <h2 id="listing_title">{{ listing.title }}</h2>
    
    <div id="content_div">
        <div id="img_div">
            <img id="listing_img" src="{{ listing.img_url }}" alt="{{ listing.title }} image">
        </div>

        <div id="right_div">
            <div id="listing_text_div">
                <p>Description: {{ listing.description }}</p>
                <p>Listed By: {{ listing.listed_by.username }}</p>
                <p>
                    Category: 
                    {% if listing.category %}
                        {{ listing.category.name }}
                    {% else %}
                        No Category
                    {% endif %}  
                </p>
                <hr>

                {% if listing.active %}
                    <p>
                        Current Price: 
                        {% if highest_bid %}
                            ${{ highest_bid.amount|floatformat:2 }}
                        {% else %}
                            ${{ listing.starting_price|floatformat:2 }} (Starting Price)
                        {% endif %} 
                    </p>
                    <p>Number of Bids: {{ bid_count }}</p>
                    {% if user.is_authenticated %}
                        <form action="{% url 'place_bid' listing.id %}" method="post">
                            {% csrf_token %}
                            <input id="bid_input" type="number" name="bid" step="0.01" placeholder="bid" value="{{bid_amt}}" required>
                            <input type="submit" value="Place Bid">
                        </form>
                        {% if error %}
                            <p id="bid_error">
                                {% if highest_bid %}
                                    Invalid bid amount. Please place a bid that is greater than the current bid of ${{ highest_bid.amount|floatformat:2 }}.
                                {% else %}
                                    Invalid bid amount. Please place a bid that is greater or equal to the starting price ${{ listing.starting_price|floatformat:2 }}.
                                {% endif %}
                            </p>
                            
                        {% endif %} 
                    {% endif %}
                {% else %}
                    {% if user == highest_bid.bidder %}
                        <p>
                            You are the winner of this auction! <br>
                            Please make payments within the next 2 days, before we ship your item over.
                        </p>
                    {% endif %}
                    <p>
                        This listing is no longer active.
                    </p>
                {% endif %}
                
                <hr>

            </div>
            <div id="buttons_div">
                {% if user.is_authenticated %}
                    {% if watchlist %}
                        <form action="{% url 'remove_watchlist' listing.id %}" method="POST">
                            {% csrf_token %}
                            <button class="listing_button" type="submit">Remove from Watchlist</button>
                        </form>
                    {% else %}
                        <form action="{% url 'add_watchlist' listing.id %}" method="POST">
                            {% csrf_token %}
                            <button class="listing_button" type="submit">Add to Watchlist</button>
                        </form>
                    {% endif %}
                    {% if user.id == listing.listed_by.id %}    
                        {% if listing.active %}
                            <form action="{% url 'close_listing' listing.id %}" method="POST">
                                {% csrf_token %}
                                <button class="listing_button" type="submit">Close Auction</button>
                            </form>
                        {% else %}
                            <p>You have closed this listing.</p>
                        {% endif %}
                    {% endif %}
                {% elif listing.active %}
                    <p>Please <a href="{% url 'login' %}">log in</a> to place a bid and add this listing to your watchlist.</p>
                {% endif %}
            </div>
        </div>
    </div>
    <hr>

    <div id="comment_section_div">
        <h3>Comments ({{ comment_count }})</h3>
        {% for comment in comments %}
            <div class="comment_div">
                <p class="comment_username">{{ comment.user.username }}</p>
                <p class="comment_comment">{{ comment.comment }}</p>
            </div>
        {% endfor %}
        
        {% if user.is_authenticated %}
            <form action="{% url 'add_comment' listing.id %}" method="post">
                {% csrf_token %}
                <input type="text" name="comment" placeholder="type something..." autocomplete="off" required>
                <input type="submit" value="comment">
            </form>
        {% endif %}
    </div>

{% endblock %}